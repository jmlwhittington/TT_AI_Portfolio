<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Classifier with Confusion Matrix</title>
    <script src="js/p5.min.js"></script>
    <script src="js/ml5.min.js"></script>
    <script src="js/tf.min.js"></script>
    <script src="js/tfjs-vis.js"></script>
</head>
<body>
    <script>
        let img;
        let label = "waiting...";
        let classifier;
        let modelURL = 'https://teachablemachine.withgoogle.com/models/OKrVwAAMU/';
        let resultsArray = []; // To store classification results
        let trueLabels = []; // True labels for visualization
        let predictedLabels = []; // Predicted labels for visualization

        // STEP 1: Load the model!
        function preload() {
            classifier = ml5.imageClassifier(modelURL + 'model.json');
        }

        function setup() {
            createCanvas(800, 800);
            // Set background to white
            document.body.style.backgroundColor = '#ffffff';

            // Create an image upload input
            let button = createFileInput(handleFile);
            button.position(100, 100);
            button.style('font-size', '18px');
        }

        // Handle the uploaded image
        function handleFile(file) {
            if (file.type === 'image') {
                img = createImg(file.data, '', '', () => {
                    img.hide();
                    classifyImage();
                });
            } else {
                console.log("Not an image file!");
            }
        }

        // STEP 2 classify the image!
        function classifyImage() {
            classifier.classify(img, gotResults);
        }

        function draw() {
            background(0);

            // Draw the uploaded image, fitting it to the canvas
            if (img) {
                image(img, (width - img.width) / 2, 0, img.width, img.height);
            }

            // Display the top three labels and their confidence scores
            if (resultsArray.length > 0) {
                textSize(24);
                textAlign(CENTER, CENTER);
                fill(255);

                // Bold the top result
                textStyle(BOLD);
                text(`${resultsArray[0].label}: ${(resultsArray[0].confidence * 100).toFixed(2)}%`, width / 2, height - 100);

                // Display the second and third results normally
                textStyle(NORMAL);
                text(`${resultsArray[1].label}: ${(resultsArray[1].confidence * 100).toFixed(2)}%`, width / 2, height - 60);
                text(`${resultsArray[2].label}: ${(resultsArray[2].confidence * 100).toFixed(2)}%`, width / 2, height - 20);
            } else {
                textSize(32);
                textAlign(CENTER, CENTER);
                fill(255);
                text(label, width / 2, height - 16);
            }
        }

        // STEP 3: Get the classification!
        function gotResults(error, results) {
            if (error) {
                console.error(error);
                return;
            }
            // Store the top 3 labels and their confidence scores
            resultsArray = results.slice(0, 3);
            label = results[0].label;

            // Prompt user to provide the true label for visualization purposes
            createTrueLabelSelection(results);
        }

        // Create radio buttons to select the true label
        function createTrueLabelSelection(results) {
            // Remove any existing label selection
            let existingDiv = document.getElementById('labelSelection');
            if (existingDiv) {
                existingDiv.remove();
            }

            // Create a new div for label selection
            let labelDiv = createDiv('Select the true label:');
            labelDiv.id('labelSelection');
            labelDiv.position(100, 150);
            labelDiv.style('font-size', '18px');

            // Create radio buttons for each label with breaks
            let radio = createRadio('trueLabel');
            radio.parent(labelDiv);
            radio.style('font-size', '18px');
            results.forEach((result) => {
                radio.option(result.label);
                let lineBreak = createElement('br');
                lineBreak.parent(labelDiv); // Add a line break after each radio button
            });

            // Add a submit button
            let submitButton = createButton('Submit');
            submitButton.parent(labelDiv);
            submitButton.style('font-size', '18px');
            submitButton.mousePressed(() => {
                let selectedLabel = radio.value();
                if (selectedLabel) {
                    let trueLabel = selectedLabel;
                    trueLabels.push(trueLabel);
                    predictedLabels.push(results[0].label);
                    updateConfusionMatrix();
                    visualizeConfusionMatrix(); // Automatically update visualization

                    // Remove label selection after submission
                    labelDiv.remove();
                }
            });
        }

        // Update the confusion matrix
        function updateConfusionMatrix() {
            // Prepare unique labels from true and predicted labels
            const uniqueLabels = Array.from(new Set(trueLabels.concat(predictedLabels)));

            // Create the confusion matrix
            let confusionMatrix = Array(uniqueLabels.length).fill().map(() => Array(uniqueLabels.length).fill(0));
            for (let i = 0; i < trueLabels.length; i++) {
                const trueIndex = uniqueLabels.indexOf(trueLabels[i]);
                const predictedIndex = uniqueLabels.indexOf(predictedLabels[i]);
                confusionMatrix[trueIndex][predictedIndex]++;
            }

            // Store the updated confusion matrix
            window.latestConfusionMatrix = { matrix: confusionMatrix, labels: uniqueLabels };
        }

        // Visualize the cumulative confusion matrix using tfjs-vis
        function visualizeConfusionMatrix() {
            if (window.latestConfusionMatrix) {
                const container = { name: 'Confusion Matrix', tab: 'Evaluation' };
                const data = { values: window.latestConfusionMatrix.matrix, tickLabels: window.latestConfusionMatrix.labels };
                tfvis.render.confusionMatrix(container, data);
            } else {
                console.log("No data available to visualize confusion matrix.");
            }
        }
    </script>
</body>
</html>
